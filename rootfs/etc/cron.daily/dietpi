#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Cron.Daily script
	#
	#////////////////////////////////////
	#
	# Info:
	# - Location: /etc/cron.daily/dietpi
	#
	#////////////////////////////////////

	#----------------------------------------------------------------
	# Main Loop
	#----------------------------------------------------------------
	# Sync system time if mode 2 (daily) is detected
	grep -q '^[[:blank:]]*CONFIG_NTP_MODE=2' /boot/dietpi.txt && /boot/dietpi/func/run_ntpd 1
	#----------------------------------------------------------------
	# Check for DietPi and/or APT updates
	APT_UPDATE_MODE=$(sed -n '/^[[:blank:]]*CONFIG_CHECK_APT_UPDATES=/{s/^[^=]*=//p;q}' /boot/dietpi.txt)
	APT_UPDATE_COUNT=0
	if grep -q '^[[:blank:]]*CONFIG_CHECK_DIETPI_UPDATES=1' /boot/dietpi.txt
	then
		/boot/dietpi/dietpi-update 2
		[[ $APT_UPDATE_MODE != 0 && -f '/run/dietpi/.apt_updates' ]] && APT_UPDATE_COUNT=$(</run/dietpi/.apt_updates)

	elif [[ $APT_UPDATE_MODE != 0 ]]
	then
		[[ -f '/run/dietpi/.apt_updates' ]] && rm /run/dietpi/.apt_updates
		apt-get -qq update && APT_UPDATE_COUNT=$(apt -qq list --upgradeable 2> /dev/null | wc -l)
		[[ $APT_UPDATE_MODE != 2 ]] && (( $APT_UPDATE_COUNT )) && echo "$APT_UPDATE_COUNT" > /run/dietpi/.apt_updates
	fi
	[[ $APT_UPDATE_MODE == 2 ]] && (( $APT_UPDATE_COUNT )) && apt-get -qq upgrade &> /var/tmp/dietpi/logs/dietpi-upgrade_apt.log
	#----------------------------------------------------------------
	# Refresh DietPi MOTD
	if [[ -f '/boot/dietpi/.dietpi-banner' ]] && grep -q '^[[:blank:]]*aENABLED\[12\]=1' /boot/dietpi/.dietpi-banner
	then
		curl -sSfL https://dietpi.com/motd > /run/dietpi/.dietpi_motd
	fi
	#----------------------------------------------------------------
	# DietPi-Sync daily
	if [[ -f '/boot/dietpi/.dietpi-sync_settings' ]] && grep -q '^[[:blank:]]*SYNC_CRONDAILY=1' /boot/dietpi/.dietpi-sync_settings
	then
		/boot/dietpi/dietpi-sync 1
	fi
	#----------------------------------------------------------------
	exit
	#----------------------------------------------------------------
} > /dev/null
